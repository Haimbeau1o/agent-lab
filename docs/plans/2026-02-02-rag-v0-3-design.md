# RAG v0.3 Design

**Goal:** 在不破坏 v0.1/v0.2 既有 Artifact/Reporter/Metric 契约的前提下，完成“真实 RAG 能力”升级与可解释 UI 落地。

## 0.3 目标优先级（已锁定）
1. Chunking 策略（句级 / 固定窗 / 滑窗）
2. span-level evidence alignment（alignment_id / span 字段）
3. Hybrid 检索（BM25 + 向量融合）
4. 强 rerank（cross-encoder / LLM judge）
5. UI：Run 详情页优先，其次 Method 对比页

## 核心架构原则
- **Runtime/Config 优先重构**：统一插件注册与管线配置，确保扩展只发生在 Method/Workflow 插件层。
- **Artifact 契约不破坏**：`rag.retrieved` / `rag.generated` 语义向后兼容，新增字段仅 append。
- **Reporter-first**：Reporter 只产解释产物（report payload），Metrics/Evaluator 读取 report 计算指标。
- **UI 可复现**：UI 仅依赖 Storage 中持久化的 RunRecord + artifacts + reports + scores。

## 数据流与模块接口（v0.3）
- Chunker：`chunk(docs, strategy) -> Chunk[]`
- Retriever：`retrieve(query, chunks, config) -> RetrievedChunk[]`
- Reranker（可选）：`rerank(retrieved) -> RetrievedChunk[]`
- Generator：`generate(retrieved, query) -> rag.generated`

**对象语义：**
- `Chunk`: `{ chunkId, text, metadata? }`
- `RetrievedChunk`: `Chunk + { score, rank }`

## 不变量与验收红线（可测试）
1. **Artifact 兼容性红线**
   - `rag.retrieved` / `rag.generated` 必须在旧 run 回放中可被 Reporter 正常消费；新增字段只能 append，Reporter 对缺失字段必须有默认回退。
2. **UI 数据依赖红线**
   - UI 仅依赖 Storage 中持久化的 RunRecord + artifacts + reports + scores；运行时 trace 只做摘要展示，不参与指标/对齐计算。
3. **Rerank/Hybrid 不变量**
   - 开关 rerank/hybrid 不得改变 Reporter 输入契约；`rag.reranked` 缺失时必须回退到 `rag.retrieved`；taxonomy 顶层类别不新增。

## 0.3 分阶段实施
**阶段 A：Runtime/Config 重构**
- 统一 pipeline 配置与插件注册
- 契约 append-only 兼容测试

**阶段 B：RAG 0.3 功能实现**
1) Chunking
2) Span-level alignment
3) Hybrid 检索
4) 强 rerank
5) 不变量测试与回退路径测试

**阶段 C：UI**
- Run 详情页（证据链 + span 高亮 + 指标面板）
- Method 对比页（聚合对比 + 入口跳转 run 详情）

